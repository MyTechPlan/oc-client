# MTP Multi-Tenant OpenClaw Infrastructure
#
# Usage:
#   docker compose up -d                    # start admin + all tenants
#   docker compose up -d admin              # start admin only
#   docker compose -f docker-compose.yml -f docker-compose.override.yml up -d
#
# Tenants are added to docker-compose.override.yml by provision-tenant.sh

x-openclaw-base: &openclaw-base
  image: ${OPENCLAW_IMAGE:-ghcr.io/openclaw/openclaw:main}
  init: true
  restart: unless-stopped
  networks:
    - mtp
  logging:
    driver: json-file
    options:
      max-size: "50m"
      max-file: "3"

x-base-env: &base-env
  HOME: /home/node
  TERM: xterm-256color
  NODE_ENV: production

services:
  # ─── Admin MTP Instance ─────────────────────────────────────
  # Has Docker socket (read-only) for container management.
  # Exposed on host for external admin access.
  admin:
    <<: *openclaw-base
    container_name: mtp-admin
    environment:
      <<: *base-env
      OPENCLAW_GATEWAY_TOKEN: ${ADMIN_GATEWAY_TOKEN:?ADMIN_GATEWAY_TOKEN is required}
      TELEGRAM_BOT_TOKEN: ${ADMIN_TELEGRAM_TOKEN:-}
      ANTHROPIC_API_KEY: ${ADMIN_ANTHROPIC_KEY:-}
      OPENAI_API_KEY: ${ADMIN_OPENAI_KEY:-}
      OPENROUTER_API_KEY: ${ADMIN_OPENROUTER_KEY:-}
    volumes:
      - ./data/admin/.openclaw:/home/node/.openclaw
      - ./data/admin/workspace:/home/node/.openclaw/workspace
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "${ADMIN_PORT:-18789}:18789"
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "lan",
        "--port",
        "18789",
      ]
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:18789/').then(r=>process.exit(r.ok||r.status===404?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ─── Tenant services are in docker-compose.override.yml ─────
  # Generated by provision-tenant.sh / remove-tenant.sh

networks:
  mtp:
    driver: bridge
